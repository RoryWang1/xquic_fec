# XQUIC视频传输性能实验设计

## 1. 研究背景和动机

### 1.1 问题陈述

传统的视频传输通常基于TCP或UDP协议：
- **TCP**: 可靠但有队头阻塞（Head-of-Line Blocking），在高丢包环境下性能下降严重
- **UDP**: 低延迟但不可靠，需要应用层自己处理丢包恢复

QUIC协议（Quick UDP Internet Connections）结合了两者优势：
- 基于UDP，支持多路复用
- 流级别的可靠性，避免队头阻塞
- 0-RTT连接建立
- 内置的拥塞控制和丢包恢复

### 1.2 研究目标

本实验旨在验证：
1. XQUIC（阿里开源的QUIC实现）在视频传输场景下相比传统UDP的性能优势
2. 在何种网络条件下XQUIC的优势最为明显
3. 量化XQUIC在不同网络环境下的性能提升

## 2. 实验设计

### 2.1 实验架构

```
┌─────────────┐
│   Camera    │ (物理摄像头)
│   Source    │
└──────┬──────┘
       │ FFmpeg捕获
       ▼
┌─────────────────────────────────────────┐
│          Video Splitter                 │
│  (FFmpeg filter_complex split)          │
└────────┬────────────────────────┬───────┘
         │                        │
         │ MPEG-TS               │ MPEG-TS
         ▼                        ▼
    ┌─────────┐             ┌──────────┐
    │  FIFO   │             │   UDP    │
    │         │             │127.0.0.1 │
    └────┬────┘             │  :5555   │
         │                  └────┬─────┘
         │                       │
         ▼                       ▼
┌─────────────────┐      ┌─────────────┐
│  XQUIC Server   │      │   Direct    │
│  (camera_server)│      │  Receiver   │
└────────┬────────┘      └──────┬──────┘
         │                      │
         │ QUIC/FEC             │ UDP
         ▼                      ▼
┌─────────────────┐      ┌─────────────┐
│  XQUIC Client   │      │   FFmpeg    │
│(camera_client)  │      │  Decoder    │
└────────┬────────┘      │   (Left)    │
         │               └──────┬──────┘
         │ MPEG-TS              │
         ▼                      │ YUV420P
    ┌─────────┐                │
    │ FFmpeg  │                ▼
    │ Decoder │          ┌──────────┐
    │ (Right) │          │ /tmp/    │
    └────┬────┘          │raw_left  │
         │               └──────┬───┘
         │ YUV420P              │
         ▼                      │
    ┌──────────┐               │
    │ /tmp/    │               │
    │raw_right │               │
    └────┬─────┘               │
         │                     │
         └──────┬──────────────┘
                ▼
        ┌──────────────┐
        │ Dual Player  │
        │  (SDL2 C)    │
        │ Side-by-Side │
        └──────────────┘
```

### 2.2 对比方法

- **左侧（对照组）**: 原始UDP传输，模拟传统视频流
- **右侧（实验组）**: 经过XQUIC传输的视频流

两个流来自同一摄像头源（通过FFmpeg split），确保输入完全一致。

### 2.3 网络模拟

使用macOS内置的`dnctl`和`pfctl`工具模拟各种网络条件：

| 场景 | 延迟(RTT) | 丢包率 | 带宽 | 模拟场景 |
|------|----------|--------|------|---------|
| baseline | 0ms | 0% | 无限制 | 理想网络（基线） |
| high_latency_50ms | 50ms | 0% | 10Mbps | 远程连接 |
| packet_loss_2pct | 50ms | 2% | 10Mbps | 轻度丢包 |
| packet_loss_5pct | 50ms | 5% | 10Mbps | 中度丢包 |
| packet_loss_10pct | 50ms | 10% | 10Mbps | 严重丢包 |
| limited_bandwidth | 50ms | 1% | 2Mbps | 移动网络 |
| challenging | 100ms | 5% | 3Mbps | 综合恶劣环境 |

## 3. 评估指标

### 3.1 核心指标

1. **帧率 (FPS)**
   - 测量方法：从FFmpeg解码器日志提取
   - 预期：XQUIC在丢包环境下保持更高帧率

2. **实际码率 (kbps)**
   - 测量方法：从FFmpeg日志提取bitrate统计
   - 预期：XQUIC码率更稳定

3. **丢帧数量**
   - 测量方法：统计FFmpeg报告的dropped frames
   - 预期：XQUIC丢帧更少

### 3.2 次要指标

1. **连接建立时间**
   - 仅针对XQUIC
   - 展示0-RTT优势

2. **错误率**
   - 统计解码错误次数
   - 预期：XQUIC错误更少

### 3.3 主观评估

- 视觉对比：通过并排播放直观观察卡顿、延迟差异
- 记录关键现象（截图/录屏）

## 4. 实验假设

### 假设1: 基线环境性能相当
在理想网络环境下，XQUIC和UDP的性能应该相似，因为QUIC的开销在良好网络下不明显。

**验证方法**: baseline场景，对比FPS和延迟

### 假设2: 丢包环境XQUIC显著优于UDP
在丢包环境中，XQUIC的多路复用特性避免队头阻塞，性能应该明显优于UDP。

**验证方法**: packet_loss_* 场景，对比丢帧率和FPS

**预期结果**:
- 2%丢包: XQUIC优势10-20%
- 5%丢包: XQUIC优势30-50%
- 10%丢包: XQUIC优势50-70%

### 假设3: 高延迟环境连接建立更快
XQUIC的0-RTT握手应该在高延迟环境下体现连接建立优势。

**验证方法**: 测量连接建立时间

### 假设4: 带宽受限时拥塞控制更优
XQUIC使用BBR拥塞控制算法，在带宽受限时应该更稳定。

**验证方法**: limited_bandwidth场景，对比码率稳定性

## 5. 实验流程

### 5.1 准备阶段
1. 编译项目和依赖
2. 生成TLS证书
3. 验证摄像头权限

### 5.2 执行阶段
1. 配置网络环境（使用dnctl/pfctl）
2. 启动camera_server
3. 启动FFmpeg视频源（split到FIFO和UDP）
4. 启动两个解码器（UDP和XQUIC）
5. 启动dual_player进行并排显示
6. 运行指定时长（建议60秒）
7. 收集日志和指标

### 5.3 数据收集
- 服务器日志：XQUIC传输统计
- 客户端日志：接收统计、连接时间
- 解码器日志：FPS、码率、丢帧
- 屏幕录制：主观质量对比

### 5.4 分析阶段
1. 使用analyze_results.py提取指标
2. 生成对比表格
3. 计算性能提升百分比
4. 可视化结果（可选）

## 6. 预期成果

### 6.1 量化数据

生成如下性能对比表：

```
场景                 | UDP FPS | XQUIC FPS | 提升
--------------------|---------|-----------|-------
baseline            | 30.0    | 30.0      | 0%
high_latency_50ms   | 29.8    | 30.0      | +0.7%
packet_loss_2pct    | 28.5    | 29.2      | +2.5%
packet_loss_5pct    | 25.3    | 28.7      | +13.4%
packet_loss_10pct   | 18.2    | 26.5      | +45.6%
limited_bandwidth   | 27.1    | 28.9      | +6.6%
challenging         | 20.5    | 27.3      | +33.2%
```

### 6.2 可视化结果

- 折线图：不同丢包率下的FPS对比
- 柱状图：各场景性能提升百分比
- 热力图：网络条件 vs 性能指标

### 6.3 论文/报告章节

实验结果可用于：
1. **Introduction**: 展示QUIC在实时视频传输中的重要性
2. **Methodology**: 详细的实验设计和对比方法
3. **Results**: 量化数据和图表
4. **Discussion**: 分析为何XQUIC在特定场景下表现更好
5. **Conclusion**: XQUIC的适用场景和建议

## 7. 潜在改进

### 7.1 增强指标收集

- 实时延迟测量（在视频帧中嵌入时间戳）
- CPU/内存使用率监控
- 网络流量统计
- 更精确的丢包恢复时间测量

### 7.2 扩展实验场景

- 网络切换测试（模拟移动场景）
- 多客户端场景
- 不同视频编码参数对比
- 长时间稳定性测试

### 7.3 自动化改进

- 自动截图/录屏
- 实时性能监控可视化
- 测试报告自动生成（包含图表）

## 8. 局限性说明

### 8.1 环境限制
- 使用localhost测试，无法完全模拟真实广域网
- 网络模拟基于统计模型，与真实网络有差异

### 8.2 简化假设
- 假设摄像头输入稳定
- 未考虑编码器性能波动
- UDP对照组未实现应用层FEC

### 8.3 改进方向
- 使用真实网络环境测试（两台物理机器）
- 对比更复杂的基线（如WebRTC的UDP实现）
- 在生产环境中验证

## 9. 时间线

- **准备**: 1-2小时（环境配置、编译）
- **基线测试**: 30分钟
- **单场景测试**: 5分钟/场景
- **批量测试**: 约10分钟（7个场景 × 60秒 + 切换时间）
- **数据分析**: 30分钟
- **报告撰写**: 根据需要

建议至少重复3次批量测试以确保数据可靠性。

## 10. 参考资料

- IETF QUIC Working Group: https://quicwg.org/
- XQUIC项目: https://github.com/alibaba/xquic
- RFC 9000 (QUIC Transport): https://www.rfc-editor.org/rfc/rfc9000
- BBR拥塞控制: https://queue.acm.org/detail.cfm?id=3022184
